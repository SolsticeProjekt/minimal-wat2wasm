
<!doctype html>
<html>
    <head>
        <meta charset="utf-8">
        <title>blablabla</title>
        <script src="libwabt.js"></script>
    </head>
<body>
<script>


var Features = {  "exceptions": false,
                  "mutable_globals": true,
                  "sat_float_to_int":false,
                  "sign_extension":false,
                  "simd":false,
                  "threads":false,
                  "multi_value":false,
                  "tail_call":false     }

var module = WabtModule().parseWat('test.wast',

`
(module
(func $addTwo (param i32 i32) (result i32)
    get_local 0
    get_local 1
    i32.add)
(export "addTwo" (func $addTwo)))
`, Features);

    module.resolveNames();
    module.validate(Features);
    var binaryOutput = module.toBinary({log: true, write_debug_names:true});
    binaryBuffer = binaryOutput.buffer;

    let wasm = new WebAssembly.Module(binaryBuffer);
    js = `const wasmInstance = new WebAssembly.Instance(wasmModule, {});
        const { addTwo } = wasmInstance.exports;`
    
    const wasmInstance = new WebAssembly.Instance(wasm, {});
    const { addTwo } = wasmInstance.exports;
    // let fn = new Function('wasmModule', 'console', js + '//# sourceURL=demo.js');
    // fn(wasm)
    // const wasmInstance =    new WebAssembly.Instance(wasmModule, {});
    // const { addTwo } = wasmInstance.exports;
    document.body.innerText = addTwo(1,3)

//
// -------------------------------------------------------------------------------------
// function SignedLEB128(value)
// {
//   const encoding = [];
//   while (true)
//   {
//     const byte = value & 127;
//     value = value >> 7;
//     const signbit = byte & 0x40;

//     if ((value === 0 && !signbit) || (value === -1 && signbit))
//     {
//       encoding.push(byte);
//       break;
//     }
//     else encoding.push(byte | 0x80);
//   }
//   return encoding;
// };

// export const encodeUnsigned = (value: number) => {
//   const encoding = [];
//   while (true) {
//     const i = value & 127;
//     value = value >>> 7;
//     if (value === 0) {
//       encoding.push(i);
//       break;
//     }

//     encoding.push(i | 0x80);
//   }

//   return encoding;
// };
// -------------------------------------------------------------------------------------
//

//
// Load file from local directory, requires that the browser is being started with the "--allow-file-access-from-files" parameter. Might only work in Chrome/-ium?
// ---------------------------------------------------------------------------------------------------------------------------------------------------------------
// var importObj = {
//   imports: {
//     imported_func: function(arg) {
//       console.log(arg);
//     }
//   }
// };
//
// const request = new XMLHttpRequest();
// request.responseType = 'arraybuffer';
// request.onload = function() {
//                                 const wasm2 = Code
//                                 console.log(wasm2)
//                                 const wasm = request.response;
//                                 WebAssembly.instantiate(wasm, importObj)
//                                            .then(prog => {  console.log(prog.instance.exports.fib(12));     });
//                             };
// request.open('GET', 'test.wasm');
// request.send();
// -------------------------------------------------------------------------------------------------------------------
</script>
</body>
</html>
